#!/bin/bash
# Setup Documentation Pre-Commit Hook
#
# Installs a git pre-commit hook that automatically maintains documentation
# before each commit.
#
# Usage: bash scripts/setup-docs-precommit.sh [--uninstall]

set -e

HOOK_FILE=".git/hooks/pre-commit"
BACKUP_FILE=".git/hooks/pre-commit.backup"

# Check if --uninstall flag is provided
if [ "$1" = "--uninstall" ]; then
    echo "ðŸ—‘ï¸  Uninstalling documentation pre-commit hook..."

    if [ -f "$BACKUP_FILE" ]; then
        mv "$BACKUP_FILE" "$HOOK_FILE"
        echo "âœ… Restored original pre-commit hook"
    elif [ -f "$HOOK_FILE" ]; then
        rm "$HOOK_FILE"
        echo "âœ… Removed documentation pre-commit hook"
    else
        echo "â„¹ï¸  No pre-commit hook found"
    fi

    exit 0
fi

echo "========================================"
echo "ðŸ“‹ Setup Documentation Pre-Commit Hook"
echo "========================================"
echo ""

# Check if git repo
if [ ! -d ".git" ]; then
    echo "âŒ Error: Not a git repository"
    exit 1
fi

# Backup existing hook if present
if [ -f "$HOOK_FILE" ]; then
    echo "âš ï¸  Existing pre-commit hook found"
    echo "   Creating backup: $BACKUP_FILE"
    cp "$HOOK_FILE" "$BACKUP_FILE"
    echo ""
fi

# Create pre-commit hook
cat > "$HOOK_FILE" << 'EOF'
#!/bin/bash
# Documentation Pre-Commit Hook
# Auto-generated by scripts/setup-docs-precommit.sh
# DO NOT EDIT - Changes will be overwritten

set -e

echo ""
echo "ðŸ“š Running documentation maintenance..."
echo ""

# Check if documentation-related files changed
DOCS_CHANGED=$(git diff --cached --name-only | grep -E '(^docs/|^app/server/routers/|^lib/db/schema\.ts|^components/|\.env\.example)' || true)

if [ -z "$DOCS_CHANGED" ]; then
    echo "â„¹ï¸  No documentation-related files changed, skipping"
    exit 0
fi

echo "ðŸ“Š Changed files requiring documentation update:"
echo "$DOCS_CHANGED" | sed 's/^/   - /'
echo ""

# Step 1: Derive repo facts
echo "ðŸ” Step 1/5: Deriving repository facts..."
pnpm docs:facts || {
    echo "âŒ Failed to derive repo facts"
    exit 1
}

# Step 2: Extract documentation tags
echo "ðŸ“ Step 2/5: Extracting documentation tags..."
pnpm docs:extract || {
    echo "âš ï¸  Warning: Documentation extraction had issues (non-critical)"
}

# Step 3: Build unified documentation
echo "ðŸ”¨ Step 3/5: Building unified documentation..."
pnpm docs:build || {
    echo "âš ï¸  Warning: Documentation build had issues (non-critical)"
}

# Step 4: Generate indices
echo "ðŸ“‡ Step 4/5: Generating documentation indices..."
pnpm docs:generate:doc-index || {
    echo "âš ï¸  Warning: Doc index generation had issues (non-critical)"
}

# Step 5: Validate documentation
echo "âœ… Step 5/5: Validating documentation..."
pnpm docs:validate || {
    echo ""
    echo "âŒ Documentation validation failed!"
    echo ""
    echo "Common fixes:"
    echo "  - Add missing frontmatter (title, description, audience, status)"
    echo "  - Fix broken links"
    echo "  - Review drift reports"
    echo ""
    echo "To skip validation (NOT RECOMMENDED):"
    echo "  git commit --no-verify"
    echo ""
    exit 1
}

# Auto-stage generated files
echo ""
echo "ðŸ“¦ Auto-staging generated documentation files..."

GENERATED_FILES=(
    "docs/dev/repo-facts.json"
    "docs/dev/doclets.yaml"
    ".claude/skills/practice-hub-docs-search/doc-index.json"
    ".claude/skills/practice-hub-docs-search/code-index.json"
)

for file in "${GENERATED_FILES[@]}"; do
    if [ -f "$file" ]; then
        git add "$file" 2>/dev/null || true
        echo "   âœ… Staged: $file"
    fi
done

# Stage updated CODE-EXTRACT sections in docs
git add docs/reference/**/*.md 2>/dev/null || true

echo ""
echo "âœ… Documentation maintenance complete!"
echo ""
EOF

# Make hook executable
chmod +x "$HOOK_FILE"

echo "âœ… Pre-commit hook installed successfully!"
echo ""
echo "The hook will run automatically before each commit and:"
echo "  1. Derive repository facts"
echo "  2. Extract @doc tags from code"
echo "  3. Build unified documentation"
echo "  4. Generate documentation indices"
echo "  5. Validate documentation"
echo "  6. Auto-stage generated files"
echo ""
echo "To skip the hook temporarily:"
echo "  git commit --no-verify"
echo ""
echo "To uninstall the hook:"
echo "  bash scripts/setup-docs-precommit.sh --uninstall"
echo ""
