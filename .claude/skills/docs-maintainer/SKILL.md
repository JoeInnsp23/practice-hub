---
name: docs-maintainer
description: Comprehensive documentation maintenance operations including facts derivation, extraction, building, validation, and drift detection
type: project
scope: gitignored
---

# Documentation Maintainer Skill

Automates documentation maintenance operations for Practice Hub's hybrid documentation system (CODE-EXTRACT + AI-GENERATED + HUMAN-AUTHORED).

## When to Use

Use this skill when:
- Documentation is out of sync with codebase
- Repo facts need updating (routes, routers, tables, components changed)
- Code documentation tags (`@doc:path#section`) were added/modified
- Documentation drift detected (AI-GENERATED sections >5% stale)
- Running pre-commit documentation validation
- Investigating documentation quality issues

## Capabilities

### 1. Derive Repo Facts
- Scans entire codebase for routes, routers, database tables, components, env vars
- Generates `docs/dev/repo-facts.json` with accurate statistics
- **NO HARD-CODED COUNTS** - all numbers derived from source code

### 2. Extract Documentation Tags
- Scans TypeScript files for `@doc:path#section` tags
- Generates `docs/dev/doclets.yaml` with extracted content
- Validates tag targets against `docs/books.yaml`

### 3. Build Unified Documentation
- Merges extracted doclets into target markdown files
- Updates CODE-EXTRACT zones between markers
- Preserves HUMAN-AUTHORED content

### 4. Validate Documentation
- **Frontmatter validation**: Checks required fields (title, description, audience, status, generated)
- **Orphan detection**: Finds docs not linked from anywhere
- **Drift detection**: Compares AI-GENERATED content against source code

### 5. Generate Indices
- **Doc index**: Searchable index for AI (practice-hub-docs-search skill)
- **Code index**: Searchable code snippets index

### 6. Audit Redundancy
- Runs depcheck, ts-prune for unused dependencies and exports
- Respects PROTECTED_FILES and PROTECTED_DEPS
- Generates comprehensive audit report

## Usage

### Full Maintenance Run
```typescript
// Run complete maintenance cycle
await runFullMaintenance({
  skipTests: false,  // Run validation tests
  commit: true,      // Auto-commit if changes detected
  verbose: true      // Detailed logging
});
```

### Individual Operations
```typescript
// Derive repo facts only
await deriveRepoFacts();

// Extract and build docs
await extractAndBuildDocs();

// Validate documentation
await validateDocumentation();

// Check for drift
await checkDocDrift();
```

### CLI Usage
```bash
# Full maintenance
pnpm docs:maintain

# Individual steps
pnpm docs:facts          # Derive repo facts
pnpm docs:extract        # Extract @doc tags
pnpm docs:build          # Build unified docs
pnpm docs:validate       # Validate all docs
pnpm docs:validate:drift # Check drift only
```

## Workflow

### Pre-Commit Hook
```bash
#!/bin/bash
# .git/hooks/pre-commit
pnpm docs:facts
pnpm docs:extract
pnpm docs:build
pnpm docs:validate

# Auto-stage generated files
git add docs/dev/repo-facts.json
git add docs/dev/doclets.yaml
git add docs/reference/**/*.md
git add .claude/skills/practice-hub-docs-search/doc-index.json
```

### CI/CD Integration
```yaml
# .github/workflows/docs-validation.yml
- name: Validate Documentation
  run: |
    pnpm docs:facts
    pnpm docs:extract
    pnpm docs:build
    pnpm docs:validate

    # Ensure generated files are up-to-date
    git diff --exit-code docs/dev/
```

## Configuration

### books.yaml
Maps `@doc:path#section` tags to target files:
```yaml
targets:
  api/clients:
    file: docs/reference/api/routers.md
    section: "<!-- BEGIN CODE-EXTRACT: api/clients -->"
    type: code-extract
    description: "Clients router procedures"
```

### Validation Thresholds
```typescript
const DRIFT_THRESHOLD = 0.05;  // 5% content change triggers drift
const STUB_MAX_AGE_MONTHS = 6; // Stale stub warning threshold
const MIN_WORD_COUNT = 50;     // Minimum words for non-stub docs
```

## Outputs

### docs/dev/repo-facts.json
```json
{
  "generated": "2025-01-24T12:00:00.000Z",
  "routes": {
    "total": 89,
    "byModule": { "client-hub": 12, "practice-hub": 23, ... },
    "files": ["app/client-hub/page.tsx", ...]
  },
  "routers": {
    "total": 44,
    "procedures": { "total": 417, "queries": 199, "mutations": 218 },
    "files": [...]
  },
  "database": {
    "tables": 80,
    "enums": 25,
    "views": 16,
    "tableNames": ["clients", "tasks", ...],
    "enumNames": ["userRole", ...],
    "viewNames": ["recent_activity", ...]
  },
  "components": { "total": 185, "ui": 42, "custom": 143, "files": [...] },
  "envVars": { "total": 45, "required": [...], "optional": [...] },
  "modules": ["client-hub", "practice-hub", "proposal-hub", ...]
}
```

### docs/dev/doclets.yaml
```yaml
generated: "AUTO-GENERATED by scripts/extract_doclets.py"
total_tags: 156
targets: 23
doclets:
  api/clients:
    - source: { file: "app/server/routers/clients.ts", line: 45 }
      target: "api/clients"
      section: "createClient"
      summary: "Creates a new client record with multi-tenant isolation"
      audience: ["dev"]
      tags: ["mutation", "clients", "trpc"]
      content: |
        Creates a client record linked to the authenticated user's tenant...
```

## Error Handling

### Common Issues

**Missing frontmatter**:
```
⚠️  No frontmatter: docs/reference/api/routers.md
Solution: Add YAML frontmatter with title, description, audience, status, generated
```

**Orphaned extraction zones**:
```
⚠️  Orphaned CODE-EXTRACT zone: api/unknown in docs/reference/api/routers.md
Solution: Either add @doc:api/unknown tags in code OR remove the extraction zone
```

**Documentation drift**:
```
⚠️  Drift detected: docs/architecture/tech-stack.md (12% changed)
Solution: Review AI-GENERATED section, update if needed, re-run docs:build
```

**Invalid doc tag**:
```
❌ Invalid target 'api/invalid' - not defined in docs/books.yaml
Solution: Add target to books.yaml OR fix the @doc tag
```

## Best Practices

1. **Run before committing**: Always run `pnpm docs:maintain` before committing code changes
2. **Review drift reports**: Check drift detection output for unintentional changes
3. **Keep books.yaml current**: Add new targets when creating new documentation sections
4. **Tag as you code**: Add `@doc` tags when writing new routers, tables, components
5. **Validate in CI**: Always run validation in CI to catch drift and missing tags

## Integration with Other Skills

- **practice-hub-docs-search**: Consumes doc-index.json for AI search
- **practice-hub-testing**: Uses repo-facts.json to discover routers for test generation
- **practice-hub-debugging**: Cross-references with REDUNDANCY_AUDIT_REPORT.json

## Scripts Reference

- `scripts/derive_repo_facts.ts` - TypeScript AST-based fact derivation
- `scripts/extract_doclets.py` - Python doclet extractor
- `scripts/build_docs.py` - Python documentation builder
- `scripts/validate-frontmatter.ts` - TypeScript frontmatter validator
- `scripts/find-orphaned-docs.sh` - Bash orphan detector
- `scripts/check_doc_drift.py` - Python drift checker

## Troubleshooting

### Extraction fails
```bash
# Check Python dependencies
pip install -r scripts/requirements-docs.txt

# Verify books.yaml syntax
python3 -c "import yaml; yaml.safe_load(open('docs/books.yaml'))"
```

### Facts derivation errors
```bash
# Check TypeScript compilation
pnpm typecheck

# Run with verbose output
tsx scripts/derive_repo_facts.ts --verbose
```

### Validation errors
```bash
# Show detailed validation output
pnpm docs:validate:frontmatter --verbose
pnpm docs:validate:orphans
pnpm docs:validate:drift --threshold 0.05
```

---

**Maintained by**: Practice Hub Documentation Team
**Last Updated**: 2025-01-24
**Version**: 1.0.0
