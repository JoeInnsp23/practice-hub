---
description: App Router tRPC architecture and file layout (Practice Hub)
globs: "app/api/trpc/**, app/server/**"
---

## Scope
- Structure and entry points for tRPC in Next.js App Router.
- Keep client hooks, SQL, and decimals in their own rules.

## Do
- Use `fetchRequestHandler` in `app/api/trpc/[trpc]/route.ts`.
- Compose feature routers in `app/server/index.ts`; export `AppRouter` type only.
- Initialize tRPC, SuperJSON, error formatter, and middleware in `app/server/trpc.ts`.
- Build Better Auth context (staff + client portal) in `app/server/context.ts`.
- Split routers by domain under `app/server/routers/*`.

## Don’t
- Don’t add tRPC under `pages/api` or use `createTRPCNext`.
- Don’t export server routers to the client; export the type only.

## References
- `app/api/trpc/[trpc]/route.ts`
- `app/server/trpc.ts`
- `app/server/context.ts`
- `app/server/index.ts`
- `app/server/routers/*`

## Minimal HTTP Handler
```ts
// app/api/trpc/[trpc]/route.ts
import { fetchRequestHandler } from "@trpc/server/adapters/fetch";
import { appRouter } from "@/app/server";
import { createContext } from "@/app/server/context";

const handler = (req: Request) =>
  fetchRequestHandler({ endpoint: "/api/trpc", req, router: appRouter, createContext });

export { handler as GET, handler as POST };
```

