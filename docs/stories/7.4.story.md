# Story 7.4: Validation & Quality Assurance

## Status
Draft

## Story
**As a** developer working on Practice Hub,
**I want** comprehensive validation of all type safety improvements,
**so that** I can confirm the epic is complete, all functionality works correctly, and the codebase is production-ready.

## Acceptance Criteria
1. `pnpm typecheck` passes with exit code 0 (0 TypeScript errors)
2. `pnpm biome check` shows 0 noExplicitAny violations
3. All existing tests pass (`pnpm test`)
4. Manual testing completed for all modified flows:
   - Invoice create/edit flow works correctly
   - Service create/edit flow works correctly
   - Onboarding questionnaire completes successfully
   - DocuSeal proposal submission processes correctly
   - Messages system sends/receives properly
5. No regressions detected in existing features
6. E2E tests pass for critical flows (if available)
7. Seed data compatibility verified (database reset works)
8. Performance: No degradation in compile time or runtime performance

## Tasks / Subtasks
- [ ] Task 1: Run all automated quality checks (AC: 1, 2, 3)
  - [ ] Run `pnpm typecheck` - verify exit code 0
  - [ ] Run `pnpm biome check` - verify 0 noExplicitAny violations
  - [ ] Run `pnpm test` - verify all tests pass
  - [ ] Document any test failures and root causes
  - [ ] Verify build succeeds: `pnpm build`

- [ ] Task 2: Manual testing - Invoice flows (AC: 4)
  - [ ] Test: Create new invoice with line items
  - [ ] Test: Edit existing invoice (modify amounts, add/remove items)
  - [ ] Test: Verify invoice calculations (subtotal, tax, total)
  - [ ] Test: Invoice form validation (required fields, number types)
  - [ ] Verify: Data saves correctly to database
  - [ ] Verify: No console errors in browser

- [ ] Task 3: Manual testing - Service flows (AC: 4)
  - [ ] Test: Create new service with all fields
  - [ ] Test: Edit existing service
  - [ ] Test: Service form validation (enums match database)
  - [ ] Verify: Service categories work correctly
  - [ ] Verify: Pricing model selection works
  - [ ] Verify: Data saves correctly to database

- [ ] Task 4: Manual testing - Onboarding flows (AC: 4)
  - [ ] Test: Complete onboarding questionnaire
  - [ ] Test: Review questionnaire data submission
  - [ ] Verify: Questionnaire types are properly defined
  - [ ] Verify: No type errors in onboarding components

- [ ] Task 5: Manual testing - DocuSeal & Messages (AC: 4)
  - [ ] Test: Create proposal and send for signature (if DocuSeal available)
  - [ ] Test: DocuSeal webhook processing (if available)
  - [ ] Test: Send message in messages system
  - [ ] Test: Receive message in messages system
  - [ ] Verify: Message types work correctly
  - [ ] Verify: No type errors in webhook handler

- [ ] Task 6: Regression testing (AC: 5)
  - [ ] Test: Client CRUD operations (create, read, update, delete)
  - [ ] Test: Task management functionality
  - [ ] Test: Dashboard loads correctly
  - [ ] Test: All module navigation works
  - [ ] Verify: No unexpected errors in Sentry (if configured)
  - [ ] Verify: No new console errors

- [ ] Task 7: E2E test validation (AC: 6)
  - [ ] Run E2E test suite (if available): `pnpm test:e2e`
  - [ ] Document E2E test results
  - [ ] Investigate any E2E failures
  - [ ] Verify critical user flows complete successfully

- [ ] Task 8: Database and performance validation (AC: 7, 8)
  - [ ] Test database reset: `pnpm db:reset`
  - [ ] Verify seed data loads correctly
  - [ ] Check TypeScript compilation time (should be < 2 min)
  - [ ] Verify no runtime performance degradation
  - [ ] Check bundle size (should not increase significantly)

- [ ] Task 9: Final epic validation
  - [ ] Review all 4 stories (7.1, 7.2, 7.3, 7.4) are complete
  - [ ] Verify all epic acceptance criteria met
  - [ ] Document any known issues or technical debt
  - [ ] Create summary report of epic completion
  - [ ] Prepare handoff documentation

## Dev Notes

### Previous Story Context
[Source: Stories 7.1, 7.2, 7.3 completion notes]

**Story 7.1 - Type Centralization:**
- ✅ 25 type exports created in `lib/trpc/types.ts`
- ✅ Centralized type patterns established
- ✅ TypeScript compilation passes (0 errors)
- ✅ 100% AC completion

**Story 7.2 - Form Type Alignment:**
- ✅ Invoice and service forms aligned with database schemas
- ✅ Architectural pivot: Type-safe transformations accepted at boundaries
- ✅ Service enums perfectly aligned (category, pricingModel, priceType)
- ✅ Forms use appropriate types (numbers for UX)
- ✅ 100% AC completion, perfect quality score

**Story 7.3 - Compiler Errors (Expected):**
- ✅ DocuSeal webhook types defined
- ✅ Messages system enums aligned
- ✅ Settings page types corrected
- ✅ Missing imports resolved
- ✅ TypeScript compilation passes (0 errors)

**Key Pattern from Epic:**
- Forms use numbers for better UX
- Type-safe conversions at boundaries (page handlers or tRPC transforms)
- No `as any` escape hatches
- Centralized types from `lib/trpc/types.ts`

### Testing Strategy Overview
[Source: tech-stack.md#Vitest, coding-standards.md#Testing Patterns]

**Testing Framework:** Vitest 3.2.4

**Test Types:**
1. **Type Checking**: `pnpm typecheck` (TypeScript compiler)
2. **Unit Tests**: `pnpm test` (Vitest)
3. **Lint Checks**: `pnpm biome check` (Biome linter)
4. **E2E Tests**: `pnpm test:e2e` (Playwright, if available)
5. **Manual Testing**: Critical user flows

**Test File Naming:**
- Pattern: `{filename}.test.ts` or `{filename}.test.tsx`
- Location: Same directory as source file

**Vitest Configuration:**
```typescript
// vitest.config.ts
export default defineConfig({
  test: {
    globals: true,
    environment: "node",
  },
});
```

[Source: coding-standards.md#Testing Patterns]
**Test Structure:**
```typescript
import { describe, it, expect, beforeEach } from "vitest";

describe("Feature Name", () => {
  beforeEach(() => {
    // Setup
  });

  it("should do something", () => {
    // Test
    expect(result).toBe(expected);
  });
});
```

### Manual Testing Standards
[Source: Epic 7, Validation Checklist]

**Critical Flows to Test:**

1. **Invoice Flow:**
   - Create: Add line items, apply tax, verify calculations
   - Edit: Modify amounts, update line items
   - Verify: Data saves with correct types (numbers → strings for DB)

2. **Service Flow:**
   - Create: All required fields, enum selections
   - Edit: Modify service details
   - Verify: Enums match database schema exactly

3. **Onboarding Flow:**
   - Complete: Full questionnaire submission
   - Verify: Types properly defined, no `as any` casts

4. **DocuSeal Flow:**
   - Send: Create proposal, send for signature
   - Webhook: Process submission webhook
   - Verify: Types defined, no null errors

5. **Messages Flow:**
   - Send: Create and send message
   - Receive: View received messages
   - Verify: Enum types work correctly

### Validation Checklist from Epic
[Source: Epic 7, Definition of Done]

**Code Quality Gates:**
- [ ] `pnpm typecheck` passes with exit code 0
- [ ] `pnpm biome check` shows 0 noExplicitAny violations
- [ ] No `as any` casts except for legitimate external library issues
- [ ] All centralized types exported from `lib/trpc/types.ts`
- [ ] All forms use schema-aligned interfaces

**Functional Validation:**
- [ ] Invoice CRUD operations work correctly
- [ ] Service management functions properly
- [ ] Onboarding flow completes successfully
- [ ] DocuSeal webhooks process correctly (if available)
- [ ] Messages system sends/receives properly
- [ ] No regression in existing features

**Testing & Documentation:**
- [ ] E2E tests pass for all modified flows (if available)
- [ ] Unit tests updated for type changes
- [ ] Type documentation added to complex interfaces
- [ ] README updated with type architecture (if needed)

**Performance & Security:**
- [ ] No performance degradation (compile time acceptable)
- [ ] No new security vulnerabilities introduced
- [ ] Type safety prevents common injection attacks
- [ ] External data properly validated

### Commands Reference
[Source: tech-stack.md#Development Commands]

**Quality Checks:**
```bash
# Type checking (PRIMARY VALIDATION)
pnpm typecheck

# Lint checking
pnpm biome check

# Unit tests
pnpm test

# E2E tests (if available)
pnpm test:e2e

# Build verification
pnpm build
```

**Database Commands:**
```bash
# Reset database (verify seed data compatibility)
pnpm db:reset

# Seed database
pnpm db:seed

# Database studio (inspect data)
pnpm db:studio
```

**Development Commands:**
```bash
# Format code
pnpm format

# Lint and fix
pnpm lint:fix
```

### Quality Metrics from Epic
[Source: Epic 7, Success Metrics]

**Quantitative Metrics:**
- TypeScript Errors: 25+ → 0 (100% reduction) ✅
- Type Violations: 99+ → 0 (100% elimination) ✅
- Type Coverage: 30% → 95%+ centralized ✅
- Build Time: <2min (no regression) ⚠️ VERIFY
- Bundle Size: No increase ⚠️ VERIFY

**Qualitative Metrics:**
- Developer Experience: IntelliSense everywhere ✅
- Code Quality: Type safety at compile time ✅
- Maintainability: Single source of truth ✅
- Bug Prevention: Catch errors before runtime ✅
- Team Confidence: No fear of refactoring ⚠️ VERIFY

### Known Issues and Technical Debt
[Source: Epic 7, Risk Mitigation]

**Pre-Existing Test Failures (NOT BLOCKING):**
- From Story 7.1: 19 failed test files (205 failing tests out of 1572 total)
- Root Cause: SQL query builder bug in workflows/tasks routers
- Status: Separate issue, not related to type centralization
- Action: Document but do not block epic completion

**Expected Test Status:**
- Tests related to type changes: MUST PASS
- Pre-existing test failures: Document and track separately
- New type-related tests: MUST PASS

### Important Considerations

1. **Focus on type safety validation** - This is a type-level epic
2. **Separate pre-existing issues** - Don't block on unrelated test failures
3. **Document regressions** - Any new issues must be investigated
4. **Performance baseline** - Verify no degradation from type changes
5. **Manual testing is critical** - Automated tests may not catch all issues
6. **E2E tests are optional** - If not available, focus on manual testing
7. **Seed data must work** - Database reset is a critical validation

### Testing Priority

**P0 (Must Test):**
- TypeScript compilation passes
- Invoice and service forms work correctly
- No `as any` violations
- Database seed data loads

**P1 (Should Test):**
- All unit tests pass
- E2E tests pass (if available)
- Messages system works
- Onboarding flow works

**P2 (Nice to Test):**
- DocuSeal webhook (requires external service)
- Performance benchmarks
- Bundle size analysis

### Success Criteria Summary
[Source: Epic 7, Definition of Done]

**Epic succeeds when:**
1. ✅ All 4 stories complete (7.1, 7.2, 7.3, 7.4)
2. ✅ TypeScript compilation passes with zero errors
3. ✅ All forms work correctly with proper types
4. ✅ No `as any` escape hatches remain in codebase
5. ✅ All acceptance criteria met across all stories
6. ✅ No regressions in existing functionality
7. ✅ Quality metrics achieved (0 errors, 95%+ type coverage)

## Testing

[Source: coding-standards.md#Testing Patterns]

**Unit Testing with Vitest:**
- Test file location: Same directory as source file with `.test.ts` extension
- Framework: Vitest 3.2.4
- Run: `pnpm test`

**Type Testing:**
- Primary validation method: TypeScript compiler (`pnpm typecheck`)
- Must pass with exit code 0
- No `any` types allowed

**Manual Testing:**
- Critical for validating user-facing functionality
- Test each modified form/flow end-to-end
- Verify data saves correctly to database

**E2E Testing:**
- Framework: Playwright (if configured)
- Run: `pnpm test:e2e`
- Optional: Only if E2E infrastructure exists

**Smoke Testing:**
- Quick validation of critical paths
- After each quality check passes
- Focus on user-facing features

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-26 | 1.0 | Initial story creation from Epic 7 | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used
_To be filled by development agent_

### Debug Log References
_To be filled by development agent_

### Completion Notes List
_To be filled by development agent_

### File List
_To be filled by development agent_

## QA Results
_To be filled by QA agent after story completion_
