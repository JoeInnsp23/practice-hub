{
  "meta": {
    "analysisTimestamp": "2025-10-27",
    "sourceDir": "docs/gap-analysis",
    "totalFeaturesAnalyzed": 102,
    "readinessScore": 95,
    "criticalGaps": 1
  },
  "gaps": [
    {
      "id": "GAP-001",
      "area": "Client Hub / Task Management",
      "feature": "My Tasks Filter",
      "status": "PARTIAL",
      "severity": "HIGH",
      "effort": "S",
      "confidence": 0.85,
      "proposedFix": "Extend filter to OR across preparer/reviewer/assignedTo fields. Add preparerId to taskDetailsView.",
      "dependencies": [
        "Add preparerId to taskDetailsView schema (lib/db/schema.ts:2797)",
        "Update filter logic in lib/db/queries/task-queries.ts:44-46"
      ],
      "acceptanceCriteria": [
        "Filter shows tasks where user is assignedTo",
        "Filter shows tasks where user is preparer",
        "Filter shows tasks where user is reviewer",
        "No duplicate tasks shown when user has multiple roles"
      ],
      "testsSuggested": [
        "e2e:client-hub.spec.ts - My Tasks filter validation",
        "Unit test: task-queries.test.ts - OR logic across 3 fields"
      ],
      "filesCurrent": [
        "lib/db/schema.ts:2788-2826",
        "lib/db/queries/task-queries.ts:44-46",
        "app/server/routers/tasks.ts:313+"
      ],
      "filesLegacy": [".archive/crm-app/src/hooks/useTasks.ts:76-79"],
      "evidence": [
        {
          "file": "docs/gap-analysis/fixes/my-tasks-filter-fix.md",
          "lines": "all",
          "description": "Complete fix proposal with schema change, OR logic implementation, and test cases"
        },
        {
          "file": "docs/gap-analysis/30-gap-table.md",
          "lines": "151-174",
          "description": "Gap comparison with legacy - OR filter missing"
        }
      ],
      "notes": "Legacy uses OR filter on 3 assignment fields. Current only checks assignedToId. Users assigned as preparer/reviewer won't see their tasks.",
      "type": "feature",
      "ownerHint": "backend",
      "estimatedMinutes": 30
    },
    {
      "id": "GAP-002",
      "area": "Proposal Hub / Quote Management",
      "feature": "Quotes Module",
      "status": "MISSING",
      "severity": "MEDIUM",
      "effort": "M",
      "confidence": 0.7,
      "proposedFix": "Verify if quotes are proposal variants (type='quote') or separate entity. If separate, implement quotes router mirroring proposals.",
      "dependencies": [],
      "acceptanceCriteria": [
        "Verify quote data model (separate table vs proposal type)",
        "If separate: create quotes router with CRUD operations",
        "If type variant: document clearly in architecture docs"
      ],
      "testsSuggested": ["If separate: quotes.test.ts - CRUD operations"],
      "filesCurrent": [],
      "filesLegacy": [".archive/proposal-app/main/src/App.tsx:32"],
      "evidence": [
        {
          "file": "docs/gap-analysis/30-gap-table.md",
          "lines": "74",
          "description": "Quote generation page visible in legacy, no quotes router found in current"
        }
      ],
      "notes": "Legacy has /quotes page. Current has no quotes router found. May be implemented as proposal variants or missing feature.",
      "type": "feature",
      "ownerHint": "backend + frontend",
      "estimatedMinutes": 240
    },
    {
      "id": "GAP-003",
      "area": "Proposal Hub / Activities",
      "feature": "Proposal Activities/Notes",
      "status": "PARTIAL",
      "severity": "MEDIUM",
      "effort": "S",
      "confidence": 0.65,
      "proposedFix": "Verify if proposal audit trail is tracked. If missing, implement proposal activities router or ensure notes system covers this.",
      "dependencies": [],
      "acceptanceCriteria": [
        "Proposal creation events logged",
        "Status change events tracked",
        "Notes tracked with timestamps",
        "Signature events captured"
      ],
      "testsSuggested": ["proposal-activities.test.ts - Activity audit trail"],
      "filesCurrent": [],
      "filesLegacy": [".archive/proposal-app/main/server/server.js:279-327"],
      "evidence": [
        {
          "file": "docs/gap-analysis/30-gap-table.md",
          "lines": "75",
          "description": "Legacy tracks proposal activities. Current may not have explicit activities."
        }
      ],
      "notes": "Legacy /api/v1/proposals/:id/activities endpoint. Check if merged into notes system or missing.",
      "type": "feature",
      "ownerHint": "backend",
      "estimatedMinutes": 180
    },
    {
      "id": "GAP-004",
      "area": "Invoice Management",
      "feature": "Invoice PDF Generation",
      "status": "PARTIAL",
      "severity": "MEDIUM",
      "effort": "S",
      "confidence": 0.6,
      "proposedFix": "Verify PDF generation capability via documents router. If missing, add invoices.generatePdf mutation similar to proposal PDFs.",
      "dependencies": [],
      "acceptanceCriteria": [
        "Generate invoice PDF",
        "Store PDF in S3",
        "Return presigned URL with TTL",
        "Track PDF generation in invoices table"
      ],
      "testsSuggested": ["invoices.test.ts - PDF generation mutation"],
      "filesCurrent": ["app/server/routers/invoices.ts"],
      "filesLegacy": [],
      "evidence": [
        {
          "file": "docs/gap-analysis/30-gap-table.md",
          "lines": "94",
          "description": "No explicit PDF generation procedure found in router inventory"
        }
      ],
      "notes": "Invoices exist but no generatePdf mutation visible. May be linked to documents system.",
      "type": "feature",
      "ownerHint": "backend",
      "estimatedMinutes": 180
    },
    {
      "id": "GAP-005",
      "area": "Reporting / Analytics",
      "feature": "Custom Report Builder",
      "status": "PARTIAL",
      "severity": "LOW",
      "effort": "L",
      "confidence": 0.6,
      "proposedFix": "Verify custom report builder capability. If basic only, document scope. If ad-hoc SQL needed, add report parameters.",
      "dependencies": [],
      "acceptanceCriteria": [
        "Define supported report types",
        "Document report parameters",
        "If ad-hoc needed: add SQL query builder with safety constraints"
      ],
      "testsSuggested": [],
      "filesCurrent": [
        "app/client-hub/reports/page.tsx",
        "app/server/routers/reports.ts"
      ],
      "filesLegacy": [".archive/crm-app/main/src/App.tsx - Reports.tsx"],
      "evidence": [
        {
          "file": "docs/gap-analysis/30-gap-table.md",
          "lines": "214",
          "description": "Legacy has reports page. Current reports may be limited."
        }
      ],
      "notes": "Reports page exists but feature scope may be limited vs legacy ad-hoc reporting.",
      "type": "feature",
      "ownerHint": "backend + product",
      "estimatedMinutes": 480
    }
  ],
  "testGaps": [
    {
      "id": "TEST-001",
      "scope": "e2e",
      "files": ["tests/e2e/regression/client-hub.spec.ts"],
      "priority": "P0",
      "description": "My Tasks filter - validates OR logic across preparer/reviewer/assignedTo",
      "suites": ["Client Hub - Task Management"]
    },
    {
      "id": "TEST-002",
      "scope": "e2e",
      "files": ["tests/e2e/regression/proposal-hub.spec.ts"],
      "priority": "P1",
      "description": "Proposal signing flow - create → send → sign → convert",
      "suites": ["Proposal Hub - DocuSeal Integration"]
    },
    {
      "id": "TEST-003",
      "scope": "e2e",
      "files": ["tests/e2e/regression/client-portal.spec.ts"],
      "priority": "P1",
      "description": "Client portal onboarding flow",
      "suites": ["Client Portal - Onboarding"]
    },
    {
      "id": "TEST-004",
      "scope": "e2e",
      "files": ["tests/e2e/regression/timesheet-approval.spec.ts"],
      "priority": "P1",
      "description": "Timesheet approval workflow",
      "suites": ["Client Hub - Time Tracking"]
    },
    {
      "id": "TEST-005",
      "scope": "e2e",
      "files": ["tests/e2e/regression/bulk-operations.spec.ts"],
      "priority": "P2",
      "description": "Bulk operations UI (bulk assign, bulk status update)",
      "suites": ["Client Hub - Task Management"]
    }
  ],
  "deprecations": [
    {
      "featureId": "Canvas Signatures",
      "recommended": "remove",
      "replacement": "DocuSeal Integration",
      "rationale": "Professional e-signature platform with audit trail, webhooks, UK compliance. Canvas signatures lack legal compliance and audit capabilities.",
      "confidence": 1.0
    },
    {
      "featureId": "Social Hub",
      "recommended": "defer",
      "replacement": "None (out of MVP scope)",
      "rationale": "Social media management out of scope for practice management MVP. Can be added post-MVP as separate initiative.",
      "confidence": 0.9
    },
    {
      "featureId": "Bookkeeping Module",
      "recommended": "remove",
      "replacement": "Xero API Integration",
      "rationale": "Xero provides superior bookkeeping features. Reduces development/maintenance burden.",
      "confidence": 1.0
    },
    {
      "featureId": "Accounts/Billing Module",
      "recommended": "remove",
      "replacement": "Stripe Dashboard",
      "rationale": "Billing is operational, not practice management. External billing platform more appropriate.",
      "confidence": 1.0
    },
    {
      "featureId": "Payroll Module",
      "recommended": "remove",
      "replacement": "External Payroll Provider",
      "rationale": "Payroll is specialized domain with complex tax/regulatory requirements. Better to use dedicated platform.",
      "confidence": 1.0
    },
    {
      "featureId": "Employee Portal (HR features)",
      "recommended": "partial",
      "replacement": "Core features in Client Hub (leave, time)",
      "rationale": "Focus on core practice management. Payslips, performance reviews, benefits are HR-specific (can use external HRIS).",
      "confidence": 0.95
    }
  ],
  "patches": [],
  "themes": [
    "Client Hub Task Management",
    "Proposal Hub DocuSeal Integration",
    "Test Coverage Expansion (E2E)",
    "Production Configuration & Documentation"
  ],
  "decisions": [
    {
      "id": "DEC-001",
      "context": "Social Hub not migrated to current app",
      "options": [
        {
          "label": "A) Migrate Social Hub",
          "pros": ["Feature parity with legacy", "Complete offering"],
          "cons": [
            "Out of MVP scope",
            "3-4 weeks effort",
            "Requires BullMQ, Redis infrastructure"
          ]
        },
        {
          "label": "B) Deprecate Social Hub",
          "pros": ["Focus on core features", "Reduced complexity"],
          "cons": ["Lose social media management capability"]
        },
        {
          "label": "C) External integration",
          "pros": ["Use specialized tools", "Best-in-class features"],
          "cons": ["Integration complexity", "Additional vendor dependency"]
        }
      ],
      "recommended": "B",
      "rationale": "Social Hub is out of scope for practice management MVP. Can be added post-MVP as separate Story.",
      "inputNeeded": "Confirm Social Hub is not required for launch"
    },
    {
      "id": "DEC-002",
      "context": "Quote management unclear (may be missing or merged with proposals)",
      "options": [
        {
          "label": "A) Quotes are proposal variants",
          "pros": ["No additional development", "Reuse proposal logic"],
          "cons": [
            "Need to document clearly",
            "May have different requirements"
          ]
        },
        {
          "label": "B) Implement separate quotes module",
          "pros": ["Feature parity with legacy", "Specialized workflow"],
          "cons": ["3-5 hours development effort", "Additional maintenance"]
        }
      ],
      "recommended": "A",
      "rationale": "Verify if quotes are proposal type variants first. If so, document clearly. Only implement separate module if required by business logic.",
      "inputNeeded": "Verify quote requirements and data model with product team"
    },
    {
      "id": "DEC-003",
      "context": "Canvas signatures deprecated in favor of DocuSeal",
      "options": [
        {
          "label": "A) DocuSeal only (no canvas)",
          "pros": ["Professional standard", "UK compliance", "Audit trail"],
          "cons": ["Legacy contracts may require canvas"]
        },
        {
          "label": "B) Implement canvas as fallback",
          "pros": ["Backward compatibility", "Offline signing option"],
          "cons": ["4-8 hours effort", "Maintenance burden"]
        }
      ],
      "recommended": "A",
      "rationale": "DocuSeal is professional e-signature standard with legal compliance. Canvas signatures deprecated by design.",
      "inputNeeded": "Confirm no legacy contracts require canvas signatures"
    }
  ],
  "blockers": [
    {
      "id": "BLOCKER-001-RESOLVED",
      "title": "DocuSeal Production Configuration",
      "description": ".env.production.example has wrong variable name (DOCUSEAL_API_URL instead of DOCUSEAL_HOST) and missing DOCUSEAL_WEBHOOK_SECRET",
      "status": "RESOLVED",
      "severity": "CRITICAL",
      "effort": "30 minutes",
      "files": [".env.production.example:31-33"],
      "notes": "FIXED per gap analysis findings. Variable names corrected and webhook secret added."
    },
    {
      "id": "BLOCKER-002-RESOLVED",
      "title": "Missing DocuSeal Integration Guide",
      "description": "No centralized guide for DocuSeal production setup, API key generation, webhook configuration, troubleshooting",
      "status": "RESOLVED",
      "severity": "HIGH",
      "effort": "2-3 hours",
      "files": ["docs/guides/integrations/docuseal.md (DOES NOT EXIST)"],
      "notes": "FIXED per gap analysis findings. Comprehensive integration guide created."
    }
  ],
  "summary": {
    "totalGaps": 5,
    "gapsBySeverity": {
      "HIGH": 1,
      "MEDIUM": 3,
      "LOW": 1
    },
    "gapsByStatus": {
      "PARTIAL": 5,
      "MISSING": 0,
      "REGRESSED": 0
    },
    "testGapCount": 5,
    "deprecationCount": 6,
    "decisionCount": 3,
    "blockerCount": 0,
    "estimatedFixEffort": "15 hours (excludes custom report builder which is low priority)",
    "readinessAssessment": "Production-ready after fixing GAP-001 (My Tasks filter). All other gaps are MEDIUM/LOW priority or require product clarification.",
    "criticalPath": [
      "GAP-001: My Tasks Filter (30 min)",
      "TEST-001: E2E test for My Tasks filter (1 hour)",
      "Validate no other critical gaps"
    ],
    "recommendedActions": [
      "Fix GAP-001 (My Tasks filter) immediately - HIGH severity",
      "Clarify quote management requirements (DEC-002)",
      "Expand E2E test coverage (TEST-001 through TEST-005)",
      "Defer custom report builder enhancement (LOW priority)",
      "Document Social Hub deprecation decision"
    ]
  }
}
