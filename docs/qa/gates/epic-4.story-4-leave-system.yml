# Quality Gate Decision - Story 4.4: Holiday/Leave Request System
# Generated by Quinn (Test Architect) on 2025-10-23

schema: 1
story: "4.4"
story_title: "Holiday/Leave Request System"
gate: CONCERNS
status_reason: "Two acceptance criteria not implemented (AC13: email notifications, AC14: carryover logic) and build currently failing. Core functionality is solid with excellent security and validation, but requires completion before production deployment."
reviewer: "Quinn (Test Architect)"
updated: "2025-10-23T23:05:00Z"

waiver: { active: false }

top_issues:
  - id: "BUILD-001"
    severity: high
    finding: "Build failing with syntax error - blocks production deployment"
    suggested_action: "Fix syntax error and run pnpm exec biome format --write on all new files"
    suggested_owner: dev

  - id: "AC-013"
    severity: high
    finding: "AC13 not implemented - Email notifications missing (submitted, approved, rejected)"
    suggested_action: "Implement email notification system using Resend/SendGrid and add to request/approve/reject mutations"
    suggested_owner: dev

  - id: "AC-014"
    severity: medium
    finding: "AC14 not implemented - Carryover logic missing (schema field exists but no business logic)"
    suggested_action: "Implement annual carryover job to transfer max 5 days unused leave to next year"
    suggested_owner: dev

  - id: "TEST-001"
    severity: medium
    finding: "No unit tests for lib/leave/working-days.ts (critical business logic)"
    suggested_action: "Add comprehensive unit tests for working days calculation, bank holiday detection, edge cases"
    suggested_owner: dev

  - id: "TEST-002"
    severity: low
    finding: "Missing tests for getConflicts, getCalendar, getHistory endpoints"
    suggested_action: "Add tRPC router tests for untested query endpoints"
    suggested_owner: dev

risk_summary:
  totals: { critical: 0, high: 2, medium: 2, low: 1 }
  highest: high
  recommendations:
    must_fix:
      - "Fix build failure (BUILD-001)"
      - "Implement email notifications (AC-013)"
      - "Implement carryover logic (AC-014)"
    monitor:
      - "Add unit tests for working-days.ts before production"
      - "UK bank holidays need annual updates (hardcoded through 2026)"

quality_score: 70
expires: "2025-11-06T00:00:00Z"

evidence:
  tests_reviewed: 6
  risks_identified: 5
  trace:
    ac_covered: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 15, 16, 17]
    ac_gaps: [13, 14]

nfr_validation:
  security:
    status: PASS
    notes: "Excellent multi-tenant isolation, proper authorization, comprehensive input validation. No security concerns identified."
  performance:
    status: PASS
    notes: "Good database indexes, efficient queries. Minor concern: getTeamLeave lacks pagination."
  reliability:
    status: CONCERNS
    notes: "Missing email notification system (AC13). Balance restoration on cancellation works correctly."
  maintainability:
    status: PASS
    notes: "Clear code structure, good naming conventions. Would benefit from JSDoc comments on tRPC procedures."

recommendations:
  immediate:
    - action: "Fix syntax error causing build failure"
      refs: ["Build output shows syntax error"]
    - action: "Run biome formatting on all new components"
      refs:
        - "components/admin/leave/approval-actions-modal.tsx"
        - "components/admin/leave/approval-list.tsx"
        - "components/client-hub/leave/leave-calendar.tsx"
    - action: "Implement email notification system (AC13)"
      refs:
        - "app/server/routers/leave.ts:203 (request mutation)"
        - "app/server/routers/leave.ts:309 (approve mutation)"
        - "app/server/routers/leave.ts:362 (reject mutation)"
    - action: "Implement carryover logic (AC14)"
      refs:
        - "lib/db/schema.ts:319 (carriedOver field exists)"
        - "Create: lib/leave/carryover-job.ts"

  future:
    - action: "Add unit tests for working-days.ts utility"
      refs: ["lib/leave/working-days.ts"]
    - action: "Add pagination to getTeamLeave endpoint"
      refs: ["app/server/routers/leave.ts:612-668"]
    - action: "Extract magic numbers to named constants"
      refs:
        - "TOIL_HOURS_PER_DAY = 7.5"
        - "DEFAULT_ANNUAL_ENTITLEMENT_UK = 25"
    - action: "Consider API for dynamic UK bank holidays (gov.uk API)"
      refs: ["lib/leave/working-days.ts:7-38"]
    - action: "Add JSDoc comments to all tRPC procedures"
      refs: ["app/server/routers/leave.ts"]

history:
  - at: "2025-10-23T23:05:00Z"
    gate: CONCERNS
    note: "Initial review - 88% of ACs implemented (15/17). Core functionality excellent but email notifications and carryover logic required before production. Build failure must be resolved."
