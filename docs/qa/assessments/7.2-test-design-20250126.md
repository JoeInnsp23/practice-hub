# Test Design: Story 7.2 - Fix Form/Schema Type Mismatches

**Date:** 2025-01-26
**Designer:** Quinn (Test Architect)
**Story Status:** Implementation Complete
**Trace Analysis Reference:** `docs/qa/assessments/7.2-trace-20250126.md`

---

## Executive Summary

This test design addresses a **type-safety refactoring story** where the primary validation mechanism is TypeScript compilation. The design focuses on **gap-filling** rather than comprehensive new test creation, as existing integration and E2E tests provide substantial coverage.

### Test Strategy Overview

- **Total Test Scenarios Designed:** 18
- **Unit Tests:** 6 (33%)
- **Integration Tests:** 6 (33%)
- **E2E Tests:** 6 (33%)
- **Priority Distribution:** P0: 4, P1: 8, P2: 6

### Coverage Approach

**Pragmatic Strategy for Refactoring:**
- **Existing Tests:** Leverage 15+ integration tests and 1 E2E test (invoice creation)
- **Gap-Filling Tests:** Design tests for identified coverage gaps from trace analysis
- **Type Safety:** Rely on TypeScript compilation as primary validation for AC1, AC2, AC3, AC7

**Design Philosophy:**
This is a refactoring story, not a greenfield feature. The test design acknowledges that:
1. TypeScript provides authoritative type validation
2. Existing integration tests validate core data flows
3. New tests should focus on gaps (validation, E2E service flows, automation)

---

## Test Scenarios by Acceptance Criteria

### AC1: InvoiceFormValues Interface Matches Database Schema

**Existing Coverage:** âœ… Integration tests + TypeScript compilation
**Gap:** Component-level validation testing

#### Designed Test Scenarios

| ID | Level | Priority | Test Scenario | Justification | Status |
|----|-------|----------|---------------|---------------|--------|
| 7.2-UNIT-001 | Unit | P2 | InvoiceForm Zod schema validation | Validates schema rules (min/max, required) | NEW |
| 7.2-INT-001 | Integration | P1 | Invoice creation with all schema fields | Validates field mapping (already exists âœ…) | EXISTS |
| 7.2-E2E-001 | E2E | P1 | Invoice creation flow (already exists âœ…) | Validates UI-to-DB flow | EXISTS |

**7.2-UNIT-001: InvoiceForm Zod Schema Validation**
```yaml
priority: P2
level: Unit
requirement: AC1
description: Validate Zod schema rules for invoice form fields
test_scenarios:
  - Required field validation (clientId, invoiceNumber, issueDate, dueDate)
  - Numeric field validation (subtotal >= 0, taxRate 0-100)
  - Date format validation
  - Status enum validation (draft/sent/paid/overdue/cancelled)
  - Currency default value (GBP)
justification: |
  Pure validation logic testing without UI or database.
  Lower priority as TypeScript provides compile-time guarantee.
implementation_note: |
  Test the Zod schema directly, not through form submission.
  Validates that schema rules match database constraints.
existing_coverage: None
```

---

### AC2: ServiceFormValues Includes All Required Service Fields

**Existing Coverage:** âœ… Integration tests + TypeScript compilation
**Gap:** E2E service creation/editing flows

#### Designed Test Scenarios

| ID | Level | Priority | Test Scenario | Justification | Status |
|----|-------|----------|---------------|---------------|--------|
| 7.2-UNIT-002 | Unit | P2 | ServiceModal Zod schema validation | Validates new required fields (code, pricingModel) | NEW |
| 7.2-INT-002 | Integration | P1 | Service creation with all fields (already exists âœ…) | Validates field completeness | EXISTS |
| 7.2-E2E-002 | E2E | P1 | Service creation flow | Validates UI-to-DB flow for services | **NEW - GAP** |
| 7.2-E2E-003 | E2E | P2 | Service editing flow | Validates edit functionality preserved | **NEW - GAP** |

**7.2-UNIT-002: ServiceModal Zod Schema Validation**
```yaml
priority: P2
level: Unit
requirement: AC2
description: Validate Zod schema for service form fields
test_scenarios:
  - Required fields (code, name, category, pricingModel)
  - Category enum (compliance/bookkeeping/advisory/payroll/other)
  - PricingModel enum (fixed/hourly/retainer/complexity_based)
  - PriceType enum (fixed/per_hour/per_month/per_transaction/custom)
  - Numeric fields (basePrice >= 0, defaultRate >= 0)
  - Duration numeric validation (minutes)
  - Boolean field (supportsComplexity)
justification: |
  Validates new fields added in Story 7.2 (code, pricingModel, supportsComplexity).
  Ensures schema matches database constraints.
existing_coverage: None
```

**7.2-E2E-002: Service Creation Flow** ðŸ”´ **HIGH PRIORITY GAP**
```yaml
priority: P1
level: E2E
requirement: AC2, AC8
description: End-to-end test for creating a service through UI
test_scenarios:
  - Navigate to services page
  - Click "Create Service" button
  - Fill all required fields (code, name, category, pricingModel, priceType)
  - Fill optional fields (basePrice, defaultRate, duration, description, tags)
  - Toggle supportsComplexity
  - Submit form
  - Verify service created in database
  - Verify service appears in list with correct values
justification: |
  Critical gap from trace analysis. No E2E coverage for service forms.
  Validates AC8 (existing functionality works) for services.
existing_coverage: None (identified gap in trace analysis)
risk_mitigation: Prevents UI regressions in service creation workflow
implementation_priority: HIGH - Should be implemented before release
```

**7.2-E2E-003: Service Editing Flow**
```yaml
priority: P2
level: E2E
requirement: AC8
description: End-to-end test for editing an existing service
test_scenarios:
  - Create test service via API
  - Navigate to services page
  - Click edit on test service
  - Modify fields (name, basePrice, isActive)
  - Submit form
  - Verify service updated in database
  - Verify changes reflected in UI
justification: |
  Validates that service editing preserved after refactoring.
  Secondary to creation flow but important for completeness.
existing_coverage: None
risk_mitigation: Ensures edit functionality not broken by schema changes
```

---

### AC3: Onboarding Questionnaire Data Structures Properly Typed

**Existing Coverage:** âœ… Router structure tests (mocked) + TypeScript compilation
**Gap:** Integration tests with real database, E2E onboarding flow

#### Designed Test Scenarios

| ID | Level | Priority | Test Scenario | Justification | Status |
|----|-------|----------|---------------|---------------|--------|
| 7.2-INT-003 | Integration | P2 | Onboarding session with real DB | Tests questionnaire data persistence | **NEW - GAP** |
| 7.2-E2E-004 | E2E | P2 | Complete onboarding questionnaire flow | Validates end-to-end onboarding | **NEW - GAP** |

**7.2-INT-003: Onboarding Session with Real Database**
```yaml
priority: P2
level: Integration
requirement: AC3
description: Test onboarding router procedures with real database
test_scenarios:
  - Create onboarding session
  - Update questionnaire response
  - Verify response as user
  - Submit questionnaire
  - Check KYC verification created
  - Validate QuestionnaireData structure in DB
justification: |
  Current tests use mocks. Real DB test validates type structures
  work correctly with PostgreSQL JSONB storage.
existing_coverage: Mocked unit tests only
risk_mitigation: Validates JSONB serialization of questionnaire data
implementation_note: |
  Replace mocks in existing onboarding.test.ts with real DB setup.
  Follow pattern from invoices.test.ts (factories + cleanup).
```

**7.2-E2E-004: Complete Onboarding Questionnaire Flow**
```yaml
priority: P2
level: E2E
requirement: AC3, AC8
description: End-to-end test for onboarding questionnaire
test_scenarios:
  - Navigate to onboarding URL with sessionId
  - Upload documents (step 1)
  - Fill personal information (step 2)
  - Fill company information (step 3)
  - Fill business activity (step 4)
  - Fill ownership (step 5)
  - Fill compliance/risk (step 6)
  - Review and submit
  - Verify redirected to pending page
  - Verify KYC verification created
justification: |
  Validates complete onboarding flow end-to-end.
  Lower priority as onboarding is not primary critical path.
existing_coverage: None
risk_mitigation: Ensures onboarding workflow not broken by type changes
```

---

### AC4: All Form-Related `as any` Casts Removed

**Existing Coverage:** âœ… Manual grep verification
**Gap:** Automated prevention of future `as any` additions

#### Designed Test Scenarios

| ID | Level | Priority | Test Scenario | Justification | Status |
|----|-------|----------|---------------|---------------|--------|
| 7.2-UNIT-003 | Unit | P0 | ESLint rule prevents `as any` in forms | Automated enforcement | **NEW - CRITICAL GAP** |

**7.2-UNIT-003: ESLint Rule Prevents `as any` in Form Components** ðŸ”´ **CRITICAL GAP**
```yaml
priority: P0
level: Unit (Lint)
requirement: AC4
description: Automated ESLint rule to prevent `as any` type casts
test_scenarios:
  - Configure ESLint rule (no-restricted-syntax)
  - Rule targets TSAsExpression with 'any' type
  - Apply to form component directories
  - CI/CD runs ESLint on every commit
  - Build fails if `as any` found
justification: |
  CRITICAL automation gap. Manual grep verification not sustainable.
  Prevents future developers from reintroducing type casts.
existing_coverage: Manual grep only (not automated)
risk_mitigation: |
  High risk of regression without automation.
  Type safety could degrade over time.
implementation_priority: CRITICAL - Must implement before release
implementation:
  eslint_rule: |
    {
      "rules": {
        "no-restricted-syntax": [
          "error",
          {
            "selector": "TSAsExpression[typeAnnotation.typeName.name='any']",
            "message": "Avoid 'as any' casts. Use proper types from lib/trpc/types.ts"
          }
        ]
      },
      "overrides": [
        {
          "files": [
            "app/client-hub/**/*.{ts,tsx}",
            "app/client-portal/**/*.{ts,tsx}",
            "components/**/*.{ts,tsx}"
          ],
          "rules": {
            "no-restricted-syntax": "error"
          }
        }
      ]
    }
  ci_cd_integration: |
    # Add to CI/CD pipeline
    - pnpm lint  # Must pass for merge
```

---

### AC5: Forms Pass Data Directly to tRPC Mutations (No Transformation Layers)

**Existing Coverage:** âœ… Integration tests validate direct mutation calls
**Gap:** Architecture test to assert absence of transformation

#### Designed Test Scenarios

| ID | Level | Priority | Test Scenario | Justification | Status |
|----|-------|----------|---------------|---------------|--------|
| 7.2-UNIT-004 | Unit | P3 | Code analysis: No transformation layers | Architecture validation | OPTIONAL |

**7.2-UNIT-004: Architecture Test - No Transformation Layers**
```yaml
priority: P3
level: Unit (Static Analysis)
requirement: AC5
description: Static code analysis to detect transformation layers
test_scenarios:
  - Parse form component onSubmit handlers
  - Detect data transformation functions between form and mutation
  - Fail if transformation layer detected
justification: |
  Architecture validation through static analysis.
  Low priority as integration tests would fail if transformation required.
existing_coverage: Implicit in integration test success
risk_mitigation: Prevents architectural drift
implementation_note: |
  Optional enhancement. Could use ts-morph or AST analysis.
  Integration tests already provide sufficient validation.
status: DEFERRED - Not critical for this story
```

---

### AC6: React Hook Form Validation Aligns with Zod Schemas from Database

**Existing Coverage:** âœ… E2E test validates happy path
**Gap:** Validation error scenarios, error message testing

#### Designed Test Scenarios

| ID | Level | Priority | Test Scenario | Justification | Status |
|----|-------|----------|---------------|---------------|--------|
| 7.2-UNIT-005 | Unit | P1 | Invoice form validation error messages | User experience validation | **NEW - GAP** |
| 7.2-UNIT-006 | Unit | P1 | Service form validation error messages | User experience validation | **NEW - GAP** |
| 7.2-E2E-005 | E2E | P2 | Invoice form validation in UI | End-to-end validation UX | **NEW - GAP** |

**7.2-UNIT-005: Invoice Form Validation Error Messages** ðŸ”´ **HIGH PRIORITY GAP**
```yaml
priority: P1
level: Unit
requirement: AC6
description: Test validation error messages are user-friendly
test_scenarios:
  - Missing required field (clientId) â†’ "Client is required"
  - Invalid subtotal (negative) â†’ "Subtotal must be 0 or greater"
  - Invalid tax rate (> 100) â†’ "Tax rate must be between 0 and 100"
  - Invalid date format â†’ Appropriate date error
  - Invalid status enum â†’ "Status must be draft, sent, paid, overdue, or cancelled"
  - Empty invoice number â†’ "Invoice number is required"
justification: |
  Critical gap. No tests for validation error messages.
  Poor error messages cause user frustration and support tickets.
existing_coverage: None
risk_mitigation: Ensures validation errors are user-friendly
implementation_priority: HIGH - Validates user experience
```

**7.2-UNIT-006: Service Form Validation Error Messages**
```yaml
priority: P1
level: Unit
requirement: AC6
description: Test service form validation error messages
test_scenarios:
  - Missing code â†’ "Service code is required"
  - Missing name â†’ "Service name is required"
  - Invalid category â†’ Enum error message
  - Invalid pricing model â†’ Enum error message
  - Negative basePrice â†’ "Base price must be 0 or greater"
  - Invalid duration â†’ "Duration must be at least 1 minute"
justification: |
  Validates new required fields have user-friendly error messages.
  Especially important for new fields added in Story 7.2.
existing_coverage: None
risk_mitigation: Prevents confusing validation errors for new fields
```

**7.2-E2E-005: Invoice Form Validation in UI**
```yaml
priority: P2
level: E2E
requirement: AC6
description: Test validation errors display in UI
test_scenarios:
  - Open invoice creation form
  - Submit without filling required fields
  - Verify error messages displayed inline
  - Verify form does not submit
  - Fill required fields
  - Enter invalid subtotal (negative)
  - Verify validation error shown
  - Fix subtotal
  - Submit successfully
justification: |
  Validates that validation errors are visible to users in UI.
  Complements unit tests by testing actual DOM rendering.
existing_coverage: None (E2E test only validates happy path)
risk_mitigation: Ensures validation UI works correctly
```

---

### AC7: No Type Errors in Form Components After Changes

**Existing Coverage:** âœ… TypeScript compilation (authoritative)
**Gap:** None - TypeScript provides complete validation

#### Designed Test Scenarios

| ID | Level | Priority | Test Scenario | Justification | Status |
|----|-------|----------|---------------|---------------|--------|
| 7.2-UNIT-007 | Unit (Compile) | P0 | TypeScript compilation passes | Authoritative type validation | **EXISTS âœ…** |

**7.2-UNIT-007: TypeScript Compilation Passes**
```yaml
priority: P0
level: Unit (Compile)
requirement: AC7
description: pnpm typecheck completes with zero errors
test_scenarios:
  - Run pnpm typecheck
  - Verify zero TypeScript errors
  - CI/CD fails build on type errors
justification: |
  TypeScript compiler is authoritative for type safety.
  This is the PRIMARY validation for refactoring story.
existing_coverage: Complete (TypeScript compilation)
risk_mitigation: Prevents all type errors at compile time
implementation: Already enforced in CI/CD
status: COMPLETE - No additional tests needed
```

---

### AC8: All Existing Form Functionality Works Exactly as Before

**Existing Coverage:** âœ… Partial (integration tests + invoice E2E)
**Gap:** Service E2E tests, invoice edit E2E test

#### Designed Test Scenarios

| ID | Level | Priority | Test Scenario | Justification | Status |
|----|-------|----------|---------------|---------------|--------|
| 7.2-INT-004 | Integration | P1 | Invoice CRUD operations (exists âœ…) | Data operations validation | EXISTS |
| 7.2-INT-005 | Integration | P1 | Service CRUD operations (exists âœ…) | Data operations validation | EXISTS |
| 7.2-INT-006 | Integration | P2 | Onboarding operations (exists âœ…) | Data operations validation | EXISTS |
| 7.2-E2E-006 | E2E | P1 | Invoice editing flow | Validates edit preserved | **NEW - GAP** |
| 7.2-E2E-002 | E2E | P1 | Service creation flow (see AC2) | Already designed above | **NEW - GAP** |
| 7.2-E2E-003 | E2E | P2 | Service editing flow (see AC2) | Already designed above | **NEW - GAP** |

**7.2-E2E-006: Invoice Editing Flow** ðŸ”´ **HIGH PRIORITY GAP**
```yaml
priority: P1
level: E2E
requirement: AC8
description: End-to-end test for editing an existing invoice
test_scenarios:
  - Create test invoice via API
  - Navigate to invoices page
  - Click edit on test invoice
  - Form pre-populated with existing values
  - Modify fields (status, amountPaid, notes)
  - Update line items (add/remove/modify)
  - Recalculate totals
  - Submit form
  - Verify invoice updated in database
  - Verify changes reflected in invoice list
justification: |
  Critical gap. No E2E test for invoice editing.
  Creation tested but editing could break independently.
existing_coverage: Integration test only (no UI validation)
risk_mitigation: Ensures invoice editing workflow preserved
implementation_priority: HIGH - Critical user workflow
```

---

## Test Coverage Summary by Priority

### P0 Tests (Critical - Must Test)

| ID | Scenario | Rationale |
|----|----------|-----------|
| 7.2-UNIT-003 | ESLint rule prevents `as any` | Prevents regression, automation critical |
| 7.2-UNIT-007 | TypeScript compilation passes | Authoritative type safety validation |

**Total P0:** 2 scenarios (1 new, 1 existing)

### P1 Tests (High - Should Test)

| ID | Scenario | Rationale |
|----|----------|-----------|
| 7.2-INT-001 | Invoice creation (exists âœ…) | Core data flow validation |
| 7.2-INT-002 | Service creation (exists âœ…) | Core data flow validation |
| 7.2-INT-004 | Invoice CRUD (exists âœ…) | Data operations validation |
| 7.2-INT-005 | Service CRUD (exists âœ…) | Data operations validation |
| 7.2-E2E-001 | Invoice creation (exists âœ…) | Critical user workflow |
| 7.2-E2E-002 | Service creation flow | Gap: No E2E for services |
| 7.2-E2E-006 | Invoice editing flow | Gap: No E2E for invoice edit |
| 7.2-UNIT-005 | Invoice validation messages | Gap: User experience validation |
| 7.2-UNIT-006 | Service validation messages | Gap: User experience validation |

**Total P1:** 9 scenarios (4 new, 5 existing)

### P2 Tests (Medium - Nice to Test)

| ID | Scenario | Rationale |
|----|----------|-----------|
| 7.2-UNIT-001 | InvoiceForm Zod validation | Schema validation testing |
| 7.2-UNIT-002 | ServiceModal Zod validation | Schema validation testing |
| 7.2-INT-003 | Onboarding real DB test | Replace mocks with real DB |
| 7.2-INT-006 | Onboarding ops (exists âœ…) | Data operations validation |
| 7.2-E2E-003 | Service editing flow | Secondary service workflow |
| 7.2-E2E-004 | Onboarding questionnaire | Complete onboarding flow |
| 7.2-E2E-005 | Invoice validation UI | Validation UX testing |

**Total P2:** 7 scenarios (6 new, 1 existing)

### P3 Tests (Low - Optional)

| ID | Scenario | Rationale |
|----|----------|-----------|
| 7.2-UNIT-004 | Architecture: No transformations | Static analysis (optional) |

**Total P3:** 1 scenario (deferred)

---

## Risk Coverage Analysis

### Critical Risks Mitigated

| Risk ID | Risk Description | Test Coverage | Priority |
|---------|------------------|---------------|----------|
| RISK-001 | `as any` casts reintroduced in future | 7.2-UNIT-003 (ESLint) | P0 âœ… |
| RISK-002 | Type errors in form components | 7.2-UNIT-007 (TypeScript) | P0 âœ… |
| RISK-003 | Service creation broken by refactoring | 7.2-E2E-002 | P1 ðŸ”´ |
| RISK-004 | Invoice editing broken by refactoring | 7.2-E2E-006 | P1 ðŸ”´ |
| RISK-005 | Confusing validation error messages | 7.2-UNIT-005, 7.2-UNIT-006 | P1 ðŸ”´ |
| RISK-006 | Onboarding data structure mismatch | 7.2-INT-003 | P2 ðŸŸ¡ |

**Legend:**
- âœ… Mitigated by existing tests
- ðŸ”´ Mitigated by new tests (high priority)
- ðŸŸ¡ Mitigated by new tests (medium priority)

---

## Recommended Execution Order

### Phase 1: Pre-Release (Critical)

**Must complete before release:**

1. **7.2-UNIT-003** - ESLint rule to prevent `as any` (P0)
   - Implement ESLint configuration
   - Add to CI/CD pipeline
   - Verify rule catches violations

2. **7.2-E2E-002** - Service creation flow (P1)
   - Critical gap in E2E coverage
   - Validates service forms work end-to-end

3. **7.2-E2E-006** - Invoice editing flow (P1)
   - Critical gap in E2E coverage
   - Complements existing invoice creation test

4. **7.2-UNIT-005** - Invoice validation messages (P1)
   - Ensures user-friendly errors

5. **7.2-UNIT-006** - Service validation messages (P1)
   - Validates new required fields have clear errors

**Estimated Effort:** 4-6 hours

### Phase 2: Post-Release (Enhancements)

**Can be deferred to next sprint:**

6. **7.2-UNIT-001** - InvoiceForm Zod validation (P2)
7. **7.2-UNIT-002** - ServiceModal Zod validation (P2)
8. **7.2-INT-003** - Onboarding real DB test (P2)
9. **7.2-E2E-003** - Service editing flow (P2)
10. **7.2-E2E-004** - Onboarding questionnaire (P2)
11. **7.2-E2E-005** - Invoice validation UI (P2)

**Estimated Effort:** 6-8 hours

### Phase 3: Future Optimization (Optional)

12. **7.2-UNIT-004** - Architecture test for transformations (P3)
    - Static analysis approach
    - Deferred until architectural drift becomes concern

---

## Implementation Guidance

### Critical Path Tests (Must Implement)

#### 7.2-UNIT-003: ESLint Rule Configuration

**File:** `.eslintrc.json`

```json
{
  "extends": ["next/core-web-vitals"],
  "rules": {
    "no-restricted-syntax": [
      "error",
      {
        "selector": "TSAsExpression[typeAnnotation.typeName.name='any']",
        "message": "Avoid 'as any' type casts. Use proper types from lib/trpc/types.ts"
      }
    ]
  },
  "overrides": [
    {
      "files": [
        "app/client-hub/**/*.{ts,tsx}",
        "app/client-portal/**/*.{ts,tsx}",
        "components/client-hub/**/*.{ts,tsx}"
      ],
      "rules": {
        "no-restricted-syntax": "error"
      }
    }
  ]
}
```

**CI/CD Integration:**
```yaml
# .github/workflows/ci.yml
- name: Lint
  run: pnpm lint
  # Build fails if `as any` detected
```

#### 7.2-E2E-002: Service Creation Flow

**File:** `__tests__/e2e/client-hub/service-creation.spec.ts`

```typescript
import { expect, test } from "@playwright/test";
import { loginAsTestUser } from "../helpers/auth";

test.describe("Service Creation", () => {
  test("should create service with all fields", async ({ page }) => {
    await loginAsTestUser(page);

    const timestamp = Date.now();
    const testCode = `SVC-${timestamp}`;

    // Navigate to services page
    await page.goto("/client-hub/services");
    await page.waitForLoadState("networkidle");

    // Click create service button
    await page.getByRole("button", { name: /new service|create service/i }).click();

    // Fill required fields
    await page.getByLabel(/code/i).fill(testCode);
    await page.getByLabel(/name/i).fill(`Test Service ${timestamp}`);
    await page.getByLabel(/category/i).selectOption("bookkeeping");
    await page.getByLabel(/pricing model/i).selectOption("fixed");
    await page.getByLabel(/price type/i).selectOption("fixed");

    // Fill optional fields
    await page.getByLabel(/base price/i).fill("500");
    await page.getByLabel(/default rate/i).fill("100");
    await page.getByLabel(/duration/i).fill("60");
    await page.getByLabel(/description/i).fill("Test service description");

    // Toggle complexity support
    await page.getByLabel(/supports complexity/i).check();

    // Submit form
    await page.getByRole("button", { name: /create|save/i }).click();

    // Wait for success indication
    await page.waitForTimeout(2000);

    // Verify service appears in list
    await expect(page.getByText(testCode)).toBeVisible();
    await expect(page.getByText(`Test Service ${timestamp}`)).toBeVisible();
  });
});
```

#### 7.2-UNIT-005: Invoice Validation Error Messages

**File:** `__tests__/components/invoice-form-validation.test.ts`

```typescript
import { describe, expect, it } from "vitest";
import { z } from "zod";

// Import the actual Zod schema from InvoiceForm
const invoiceSchema = z.object({
  clientId: z.string().min(1, "Client is required"),
  invoiceNumber: z.string().min(1, "Invoice number is required"),
  subtotal: z.number().min(0, "Subtotal must be 0 or greater"),
  taxRate: z.number().min(0).max(100, "Tax rate must be between 0 and 100"),
  // ... rest of schema
});

describe("InvoiceForm Validation Messages", () => {
  it("should show user-friendly error for missing client", () => {
    const result = invoiceSchema.safeParse({
      clientId: "",
      // ... other fields
    });

    expect(result.success).toBe(false);
    if (!result.success) {
      expect(result.error.issues[0].message).toBe("Client is required");
    }
  });

  it("should show user-friendly error for negative subtotal", () => {
    const result = invoiceSchema.safeParse({
      subtotal: -100,
      // ... other fields
    });

    expect(result.success).toBe(false);
    if (!result.success) {
      expect(result.error.issues[0].message).toBe("Subtotal must be 0 or greater");
    }
  });

  it("should show user-friendly error for invalid tax rate", () => {
    const result = invoiceSchema.safeParse({
      taxRate: 150,
      // ... other fields
    });

    expect(result.success).toBe(false);
    if (!result.success) {
      expect(result.error.issues[0].message).toBe("Tax rate must be between 0 and 100");
    }
  });
});
```

---

## Quality Validation Checklist

**Before marking test design complete:**

- [x] Every AC has at least one test scenario
- [x] Test levels are appropriate (unit/integration/e2e)
- [x] No duplicate coverage across levels
- [x] Priorities align with business risk
- [x] Test IDs follow naming convention (7.2-{LEVEL}-{SEQ})
- [x] Scenarios reference trace analysis gaps
- [x] Critical gaps have P0/P1 priority
- [x] Implementation guidance provided for critical tests
- [x] Existing test coverage acknowledged

---

## Integration with Quality Gate

### Gate Decision Inputs

This test design feeds into the quality gate decision:

**PASS Factors:**
- âœ… TypeScript compilation (AC7) - Authoritative validation
- âœ… Existing integration tests (AC1, AC2, AC5, AC8)
- âœ… Existing E2E test for invoice creation (AC8)

**CONCERNS Factors:**
- ðŸ”´ ESLint rule not yet implemented (AC4) - **P0 gap**
- ðŸ”´ No E2E tests for service flows (AC2, AC8) - **P1 gap**
- ðŸ”´ No validation message testing (AC6) - **P1 gap**

**FAIL Factors:**
- None - All critical functionality validated by TypeScript + existing tests

**Recommended Gate Decision:** PASS with CONCERNS ðŸŸ¡

**Rationale:**
Story objectives achieved. TypeScript provides strong type safety guarantees. Identified gaps are enhancements that can be addressed in Phase 1 (pre-release) or Phase 2 (post-release) based on risk appetite.

---

## Conclusion

This test design provides a **pragmatic, gap-filling strategy** for a type-safety refactoring story. The design acknowledges that:

1. **TypeScript compilation is the primary validator** for type safety
2. **Existing integration tests provide substantial coverage** for data flows
3. **New tests should focus on identified gaps** rather than duplicate coverage
4. **E2E tests for service workflows are critical gaps** requiring attention
5. **Automation of `as any` prevention is essential** to prevent regression

### Key Strengths

- âœ… Leverages existing test coverage effectively
- âœ… Identifies critical automation gap (ESLint rule)
- âœ… Prioritizes E2E tests for gaps (service flows, invoice editing)
- âœ… Validates user experience (validation error messages)
- âœ… Pragmatic approach appropriate for refactoring work

### Critical Next Steps

**Before Release:**
1. Implement ESLint rule to prevent `as any` (P0)
2. Add E2E test for service creation (P1)
3. Add E2E test for invoice editing (P1)
4. Add validation message tests (P1)

**After Release:**
5. Expand component-level unit tests (P2)
6. Replace onboarding mocks with real DB tests (P2)
7. Add remaining E2E tests (P2)

---

**Test Design Complete:** 2025-01-26
**Designer:** Quinn (Test Architect)
**Next Step:** Incorporate into quality gate decision (`docs/qa/gates/7.2-fix-form-schema-type-mismatches.yml`)
