# Story 5.3 Deferred Work - Bulk Operations Extensions

**Date:** 2025-10-26
**Story:** STORY-5.3 - Bulk Operations Extensions
**Status:** Story Completed with Deferred Items
**Priority:** Medium

---

## Executive Summary

Story 5.3 (Bulk Operations Extensions) has been successfully completed with **21 of 23 acceptance criteria fully implemented**. This document tracks the 2 deferred items that require follow-up in future stories.

**Completion Status:**
- ✅ 12 router mutations implemented across 4 entity types
- ✅ 4 BulkActionBar UI components created
- ✅ Transaction safety and audit logging implemented
- ✅ Admin protection for self-deactivation implemented
- ⚠️ 2 acceptance criteria deferred (AC14, AC21 visual enhancement)

---

## Deferred Items

### 1. AC14: Server-Side ZIP Creation for Document Download

**Status:** ⚠️ Deferred
**Priority:** Medium
**Estimated Effort:** 2-3 days
**Blocking Factors:** Infrastructure requirements

#### Description

The bulk document operations include "download as ZIP" functionality that requires server-side ZIP file generation. While the UI infrastructure is ready (BulkActionBar component), the backend implementation requires additional infrastructure setup.

#### Current State

**Implemented:**
- ✅ DocumentsBulkActionBar component with download button slot
- ✅ `bulkMove`, `bulkChangeCategory`, `bulkDelete` mutations
- ✅ Document storage integration with MinIO/S3

**Not Implemented:**
- ❌ Server-side ZIP archive creation
- ❌ Temporary file management for ZIP downloads
- ❌ Stream-based ZIP generation for large file sets
- ❌ Progress tracking for ZIP creation (>100MB archives)

#### Technical Requirements

1. **ZIP Library Selection:**
   - Evaluate: `archiver`, `jszip`, `node-stream-zip`
   - Requirement: Stream support for large files (>500MB total)
   - Requirement: Memory-efficient for concurrent requests

2. **File Retrieval:**
   - Fetch document files from MinIO/S3 storage
   - Handle missing/corrupted files gracefully
   - Support different document types (PDF, DOCX, images, etc.)

3. **Temporary File Management:**
   - Create ZIP in temp directory (`/tmp` or OS temp)
   - Clean up after download completes
   - Implement timeout cleanup (remove files >1 hour old)

4. **API Endpoint:**
   - New tRPC mutation: `documents.bulkDownloadZip`
   - Input: `{ documentIds: string[], zipName?: string }`
   - Response: Stream or signed download URL
   - Max file size limit (e.g., 2GB)

5. **Progress Tracking:**
   - For large archives, implement progress updates
   - Client-side polling or WebSocket for status
   - Show: "Preparing ZIP... 15/45 files processed"

#### Implementation Example

```typescript
// app/server/routers/documents.ts
bulkDownloadZip: protectedProcedure
  .input(
    z.object({
      documentIds: z.array(z.string()).min(1).max(100),
      zipName: z.string().optional(),
    }),
  )
  .mutation(async ({ ctx, input }) => {
    const { tenantId, userId } = ctx.authContext;

    // Verify documents belong to tenant
    const documents = await db
      .select()
      .from(documents)
      .where(
        and(
          inArray(documents.id, input.documentIds),
          eq(documents.tenantId, tenantId)
        )
      );

    if (documents.length !== input.documentIds.length) {
      throw new TRPCError({
        code: "NOT_FOUND",
        message: "One or more documents not found",
      });
    }

    // Create ZIP archive
    const archiver = require("archiver");
    const archive = archiver("zip", { zlib: { level: 9 } });

    // Add files from S3/MinIO to archive
    for (const doc of documents) {
      const fileStream = await downloadFromS3(doc.storageKey);
      archive.append(fileStream, { name: doc.fileName });
    }

    await archive.finalize();

    // Return signed URL or stream
    return { downloadUrl: signedUrl, expiresAt: new Date() };
  });
```

#### Follow-Up Story Recommendation

**Story Title:** "Bulk Document ZIP Download"
**Epic:** Epic 5 - Bulk Operations & Data Import
**Dependencies:**
- Current MinIO/S3 storage implementation
- Document file storage is working correctly

**Acceptance Criteria:**
1. tRPC mutation `documents.bulkDownloadZip` implemented
2. Server-side ZIP creation with streaming support
3. Max 100 documents or 2GB total size limit
4. Temporary file cleanup after download
5. Progress tracking for archives >50 files
6. Error handling for missing/corrupted files
7. Activity logging for bulk downloads
8. Multi-tenant isolation (verify all docs belong to tenant)

---

### 2. AC21: Visual Progress Indicators for Operations >10 Items

**Status:** ⚠️ Partially Implemented (Structure Ready)
**Priority:** Low
**Estimated Effort:** 1-2 days
**Blocking Factors:** None (enhancement only)

#### Description

Acceptance Criteria 21 requires visual progress indicators (progress bars) for bulk operations affecting more than 10 items. The data structure for progress tracking is fully implemented, but the visual UI components need enhancement.

#### Current State

**Implemented:**
- ✅ Backend progress tracking (sent/failed counts for emails)
- ✅ Toast notifications with progress data ("Sent 8 email(s), 2 failed")
- ✅ Loading states during mutations (`isPending` flags)
- ✅ Disabled buttons during operations

**Not Implemented:**
- ❌ Visual progress bar component (0% → 100%)
- ❌ Real-time progress updates during operation
- ❌ Estimated time remaining display
- ❌ Cancelable long-running operations

#### Technical Requirements

1. **Progress Bar Component:**
   - Create reusable `ProgressBar` component in `components/ui/`
   - Props: `current`, `total`, `label`, `showPercentage`
   - Visual design: Follow Practice Hub glass-card style

2. **Real-Time Progress:**
   - For operations >10 items, show incremental progress
   - Options:
     - **Client-side batching:** Process in chunks, update after each
     - **Polling:** Long-running task ID + status endpoint
     - **WebSocket:** Real-time push updates (more complex)

3. **Enhanced Dialogs:**
   - Update BulkActionBar dialogs to show progress bar
   - Replace "Sending..." with "Sending 8/15 emails..."
   - Show progress bar below action buttons

4. **Cancellation Support:**
   - Add "Cancel" button during long operations
   - Abort transaction and rollback changes
   - Show partial results: "Cancelled after 8/15 completed"

#### Implementation Example

```typescript
// components/ui/progress-bar.tsx
interface ProgressBarProps {
  current: number;
  total: number;
  label?: string;
  showPercentage?: boolean;
}

export function ProgressBar({ current, total, label, showPercentage = true }: ProgressBarProps) {
  const percentage = Math.round((current / total) * 100);

  return (
    <div className="space-y-2">
      {label && (
        <div className="flex items-center justify-between text-sm">
          <span className="text-muted-foreground">{label}</span>
          {showPercentage && (
            <span className="font-medium">{percentage}%</span>
          )}
        </div>
      )}
      <div className="w-full bg-muted rounded-full h-2 overflow-hidden">
        <div
          className="bg-primary h-full transition-all duration-300 ease-in-out"
          style={{ width: `${percentage}%` }}
        />
      </div>
      <div className="flex items-center justify-between text-xs text-muted-foreground">
        <span>{current} of {total} completed</span>
      </div>
    </div>
  );
}

// Usage in BulkActionBar
const [progress, setProgress] = useState({ current: 0, total: 0 });

const handleBulkSendEmails = async () => {
  setProgress({ current: 0, total: selectedInvoiceIds.length });

  // If >10 items, process in batches and update progress
  if (selectedInvoiceIds.length > 10) {
    const batchSize = 5;
    for (let i = 0; i < selectedInvoiceIds.length; i += batchSize) {
      const batch = selectedInvoiceIds.slice(i, i + batchSize);
      await bulkSendEmailsMutation.mutateAsync({ invoiceIds: batch });
      setProgress({ current: i + batch.length, total: selectedInvoiceIds.length });
    }
  } else {
    // Small batch, send all at once
    await bulkSendEmailsMutation.mutateAsync({ invoiceIds: selectedInvoiceIds });
  }
};

// In dialog:
{progress.total > 0 && (
  <ProgressBar
    current={progress.current}
    total={progress.total}
    label="Sending emails"
    showPercentage
  />
)}
```

#### Follow-Up Story Recommendation

**Story Title:** "Enhanced Progress Indicators for Bulk Operations"
**Epic:** Epic 5 - Bulk Operations & Data Import
**Dependencies:**
- Story 5.3 bulk operations must be complete

**Acceptance Criteria:**
1. ProgressBar component created in `components/ui/`
2. Visual progress bar shown for operations >10 items
3. Real-time progress updates (current/total)
4. Percentage display and estimated time remaining
5. Support for all 4 BulkActionBar components:
   - ClientsBulkActionBar
   - InvoicesBulkActionBar
   - DocumentsBulkActionBar
   - UsersBulkActionBar
6. Optional: Cancellation support for long operations
7. Design follows Practice Hub glass-card style
8. Responsive layout for mobile devices

---

## Additional Deferred Item: Test Suite

**Status:** ⚠️ Deferred
**Priority:** High
**Estimated Effort:** 3-5 days

### Description

Comprehensive test coverage for all bulk operations was deferred to a dedicated testing story. This is a critical follow-up to ensure production readiness.

### Required Tests

#### 1. Router Unit Tests

**Clients Router** (`app/server/routers/clients.ts`):
- `bulkUpdateStatus` - Status transitions, validation, multi-tenant isolation
- `bulkAssignManager` - Manager validation, activity logging
- `bulkDelete` - Cascade behavior, activity logging

**Invoices Router** (`app/server/routers/invoices.ts`):
- `bulkUpdateStatus` - Status transitions, paidDate auto-setting
- `bulkSendEmails` - Email tracking, sent/failed counts, activity logging
- `bulkDelete` - Cascade to invoice items, activity logging

**Documents Router** (`app/server/routers/documents.ts`):
- `bulkMove` - Folder validation, parent ID handling
- `bulkChangeCategory` - Tag replace vs add modes, JSONB operations
- `bulkDelete` - Activity logging

**Users Router** (`app/server/routers/users.ts`):
- `bulkUpdateStatus` - **Critical: AC18 admin protection test**
- `bulkChangeRole` - Role validation, activity logging
- `bulkAssignDepartment` - Department validation, null handling

#### 2. Component Integration Tests

**BulkActionBar Components:**
- Selection state management
- Dialog open/close behavior
- Form validation (required fields)
- Mutation success/error handling
- Toast notification display
- Auto-clear selection after success

#### 3. Critical Test Cases

**AC18 Admin Protection:**
```typescript
it("should prevent bulk deactivation of own account", async () => {
  const currentUserId = "user-123";
  const otherUserId = "user-456";

  // Attempt to deactivate self + others
  await expect(
    caller.users.bulkUpdateStatus({
      userIds: [currentUserId, otherUserId],
      status: "inactive",
    })
  ).rejects.toThrow("Cannot deactivate your own account");
});

it("should allow bulk deactivation of other users", async () => {
  const result = await caller.users.bulkUpdateStatus({
    userIds: ["user-456", "user-789"],
    status: "inactive",
  });

  expect(result.success).toBe(true);
  expect(result.count).toBe(2);
});
```

**Transaction Rollback:**
```typescript
it("should rollback all changes on partial failure", async () => {
  const validClientId = "client-123";
  const invalidClientId = "client-invalid";

  await expect(
    caller.clients.bulkUpdateStatus({
      clientIds: [validClientId, invalidClientId],
      status: "active",
    })
  ).rejects.toThrow("One or more clients not found");

  // Verify validClientId was NOT updated (rollback succeeded)
  const client = await db.select()
    .from(clients)
    .where(eq(clients.id, validClientId));

  expect(client[0].status).not.toBe("active");
});
```

**Multi-Tenant Isolation:**
```typescript
it("should not allow cross-tenant bulk operations", async () => {
  const tenant1ClientId = "client-tenant1";
  const tenant2ClientId = "client-tenant2";

  // User from tenant1 tries to update tenant2's client
  await expect(
    tenant1Caller.clients.bulkUpdateStatus({
      clientIds: [tenant1ClientId, tenant2ClientId],
      status: "active",
    })
  ).rejects.toThrow("One or more clients not found");
});
```

**Activity Logging:**
```typescript
it("should create activity logs for each entity", async () => {
  const clientIds = ["client-1", "client-2", "client-3"];

  await caller.clients.bulkUpdateStatus({
    clientIds,
    status: "active",
  });

  const logs = await db.select()
    .from(activityLogs)
    .where(
      and(
        eq(activityLogs.action, "bulk_status_update"),
        eq(activityLogs.entityType, "client")
      )
    );

  expect(logs.length).toBe(3);
  expect(logs.every(log => clientIds.includes(log.entityId))).toBe(true);
});
```

### Follow-Up Story Recommendation

**Story Title:** "Test Suite for Bulk Operations"
**Epic:** Epic 5 - Bulk Operations & Data Import
**Dependencies:**
- Story 5.3 bulk operations complete
- Practice Hub testing infrastructure (Vitest, tRPC test utils)

**Acceptance Criteria:**
1. Unit tests for all 12 router mutations (>90% coverage)
2. Integration tests for all 4 BulkActionBar components
3. Critical test: AC18 admin protection validation
4. Transaction rollback tests for all operations
5. Multi-tenant isolation tests for all routers
6. Activity logging verification tests
7. SQL safety tests (inArray vs ANY pattern)
8. Performance tests for operations with 100+ items
9. All tests pass in CI/CD pipeline
10. Test documentation added to `/docs/guides/testing/`

---

## Recommendations

### Immediate Follow-Up (High Priority)

1. **Create Test Suite Story** (3-5 days)
   - Critical for production readiness
   - Validates AC18 admin protection
   - Ensures transaction safety and multi-tenant isolation

### Short-Term Follow-Up (Medium Priority)

2. **ZIP Download Implementation** (2-3 days)
   - Completes AC14 from Story 5.3
   - High value for document management users
   - Requires infrastructure setup

### Long-Term Enhancement (Low Priority)

3. **Visual Progress Indicators** (1-2 days)
   - Enhances AC21 from Story 5.3
   - Improves UX for large bulk operations
   - No blocking dependencies

---

## Risk Assessment

### Testing Gap (HIGH RISK)

**Risk:** Production deployment without comprehensive test coverage
**Impact:** Potential data corruption, cross-tenant access, failed transactions
**Mitigation:**
- Prioritize test suite story before production deployment
- Manual QA testing of critical paths (AC18 admin protection)
- Monitor Sentry for errors in production

### ZIP Download Infrastructure (MEDIUM RISK)

**Risk:** Deferred AC14 may block user workflows requiring bulk document downloads
**Impact:** Users manually download files one-by-one (productivity loss)
**Mitigation:**
- Document workaround: "Download individually for now"
- Prioritize if user feedback indicates high demand
- Consider alternative: Client-side ZIP creation (browser-based)

### Progress Indicator UX (LOW RISK)

**Risk:** Users may not perceive progress for long bulk operations
**Impact:** Users may think operation has frozen (perceived bug)
**Mitigation:**
- Current loading states and toast messages provide basic feedback
- "Sending emails..." message indicates activity
- Can be enhanced later without blocking workflows

---

## Tracking

**Document Owner:** Development Team
**Review Date:** 2025-11-02 (1 week)
**Next Steps:**
1. Review deferred items with product owner
2. Prioritize follow-up stories in backlog
3. Create story tickets for test suite and ZIP download
4. Monitor user feedback for progress indicator demand

**Related Documents:**
- `/docs/stories/epic-5/story-3-bulk-operations-extensions.md` - Original story
- `/docs/architecture/api-design.md` - tRPC patterns
- `/docs/guides/testing/` - Testing guidelines (future)

---

**Last Updated:** 2025-10-26
**Status:** Active - Awaiting Follow-Up Stories
