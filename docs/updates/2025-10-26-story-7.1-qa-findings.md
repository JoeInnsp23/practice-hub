# QA Findings from Story 7.1 Review
**Date**: 2025-10-26
**Reviewer**: Quinn (Test Architect)
**Story**: 7.1 - Centralize All tRPC Router Output Types
**Gate Decision**: ‚úÖ PASS (Quality Score: 95/100)

---

## Purpose
This document captures issues and recommendations discovered during the QA review of Story 7.1. These items were identified but are **NOT blocking** for the current story. They should be tracked as separate work items.

---

## üî¥ Critical Issues (Separate Story Needed)

### Issue 1: Pre-Existing Test Failures - SQL Query Builder Bug

**Severity**: High
**Category**: Bug / Technical Debt
**Status**: Pre-existing (NOT introduced by Story 7.1)

**Description**:
19 test files are failing (205 tests out of 1572 total) due to a SQL query builder error in the workflows and tasks routers.

**Error Message**:
```
TypeError: tx.select(...).from(...).where(...).limit is not a function
```

**Affected Files**:
- `app/server/routers/workflows.ts:601`
- `app/server/routers/tasks.ts:835`

**Impact**:
- ~13% of test suite failing
- Affects workflow versioning and task assignment functionality
- Potential runtime issues if this code path is executed

**Root Cause Hypothesis**:
The Drizzle ORM query builder chain appears to be broken. The `.limit()` method is not available on the query object, suggesting either:
1. Incorrect query builder API usage
2. Drizzle ORM version incompatibility
3. Missing import or type definition

**Example Failing Tests**:
- `__tests__/routers/workflows.versioning.test.ts`
  - "should validate rollbackToVersion input"
  - "should validate migrateInstances input"
- `__tests__/routers/workflows.test.ts`
- Task assignment tests in workflows

**Recommended Actions**:
1. **Investigate Query Builder Chain**: Review Drizzle ORM documentation for correct query builder usage
2. **Check Version Compatibility**: Verify Drizzle ORM version matches expected API
3. **Fix Implementation**: Update query builder calls to use correct API
4. **Verify Tests**: Run full test suite to confirm fixes
5. **Add Regression Tests**: Ensure this pattern is covered by tests

**Story Suggestions**:
- **Title**: "Fix SQL Query Builder Bug in Workflows/Tasks Routers"
- **Priority**: High (13% test suite failing)
- **Epic**: Technical Debt / Bug Fixes
- **Estimated Effort**: 2-4 hours (investigation + fix + verification)

**References**:
- Drizzle ORM Query Builder Docs: https://orm.drizzle.team/docs/select
- Test failures documented in Story 7.1 QA Results

---

## üü° Recommended Improvements (Nice-to-Have)

### Recommendation 1: Add Type Validation Tests

**Severity**: Low
**Category**: Test Coverage / Quality Improvement
**Status**: Enhancement

**Description**:
Currently, type exports in `lib/trpc/types.ts` are validated only by TypeScript compilation. There's no automated test to ensure type exports stay in sync with router definitions as the codebase evolves.

**Risk**:
As new routers are added or existing procedures are modified, type exports may drift out of sync, leading to:
- Stale type definitions
- Missing type exports for new routers
- Incorrect type definitions for updated procedures

**Recommended Solution**:
Create a dedicated test file to validate type exports:

```typescript
// __tests__/lib/trpc-types.test.ts
import { describe, it, expectTypeOf } from 'vitest';
import type { RouterOutputs, ClientListOutput, Client } from '@/lib/trpc/types';
import type { AppRouter } from '@/app/server';
import type { inferRouterOutputs } from '@trpc/server';

describe('tRPC Type Exports', () => {
  it('should have RouterOutputs matching AppRouter outputs', () => {
    type Expected = inferRouterOutputs<AppRouter>;
    expectTypeOf<RouterOutputs>().toEqualTypeOf<Expected>();
  });

  it('should have ClientListOutput matching clients.list output', () => {
    expectTypeOf<ClientListOutput>()
      .toEqualTypeOf<RouterOutputs['clients']['list']>();
  });

  it('should have Client matching clients.list array item', () => {
    expectTypeOf<Client>()
      .toEqualTypeOf<RouterOutputs['clients']['list']['clients'][number]>();
  });

  // Add similar tests for other commonly-used types
});
```

**Benefits**:
- Prevents type drift as routers evolve
- Documents expected type structure
- Catches breaking changes early
- Serves as living documentation

**Estimated Effort**: 2-3 hours

**Story Suggestion**:
- **Title**: "Add Type Validation Tests for Centralized tRPC Types"
- **Priority**: Low (nice-to-have)
- **Epic**: Technical Debt / Quality Improvements
- **Acceptance Criteria**:
  1. Test file created in `__tests__/lib/trpc-types.test.ts`
  2. Tests validate RouterOutputs matches AppRouter
  3. Tests cover all commonly-used type exports
  4. Tests run in CI pipeline

---

### Recommendation 2: Create Router Type Export Coverage Report

**Severity**: Low
**Category**: Developer Experience / Tooling
**Status**: Enhancement

**Description**:
Currently, there's no automated way to track which routers have centralized type exports and which don't. This makes it difficult to:
- Identify gaps when new routers are added
- Ensure consistency across the codebase
- Onboard new developers

**Current State**:
- 43 routers in AppRouter (actual count)
- 25 type exports in `lib/trpc/types.ts` (covering ~20 routers)
- ~53% coverage (no automated tracking)

**Recommended Solution**:
Create a script to generate a coverage report:

```typescript
// scripts/check-trpc-type-coverage.ts
import { AppRouter } from '@/app/server';
import * as Types from '@/lib/trpc/types';

// Extract all router names from AppRouter
const allRouters = Object.keys(AppRouter._def.procedures);

// Extract all type exports from lib/trpc/types.ts
const exportedTypes = Object.keys(Types);

// Generate coverage report
const coverage = allRouters.map(router => ({
  router,
  hasTypeExport: exportedTypes.some(t => t.toLowerCase().includes(router.toLowerCase())),
  priority: getPriority(router), // Based on usage frequency
}));

// Output report
console.log('Router Type Export Coverage:');
console.log(`Total Routers: ${allRouters.length}`);
console.log(`Covered Routers: ${coverage.filter(c => c.hasTypeExport).length}`);
console.log(`Coverage: ${(coverage.filter(c => c.hasTypeExport).length / allRouters.length * 100).toFixed(1)}%`);

// List gaps
const gaps = coverage.filter(c => !c.hasTypeExport && c.priority === 'high');
if (gaps.length > 0) {
  console.log('\nHigh-priority gaps:');
  gaps.forEach(g => console.log(`  - ${g.router}`));
}
```

**Benefits**:
- Visibility into type export coverage
- Proactive identification of gaps
- Helps prioritize which routers need type exports
- Supports onboarding and documentation

**Estimated Effort**: 3-4 hours

**Story Suggestion**:
- **Title**: "Create Router Type Export Coverage Report Tool"
- **Priority**: Low (nice-to-have)
- **Epic**: Developer Experience / Tooling
- **Acceptance Criteria**:
  1. Script created in `scripts/check-trpc-type-coverage.ts`
  2. Reports total routers, covered routers, and coverage percentage
  3. Identifies high-priority gaps based on usage
  4. Can be run via `pnpm run type-coverage`
  5. Optional: Add to CI as informational check

---

## üìä Summary

| Issue/Recommendation | Severity | Priority | Estimated Effort | Status |
|---------------------|----------|----------|------------------|--------|
| SQL Query Builder Bug | High | High | 2-4 hours | Pre-existing, needs story |
| Type Validation Tests | Low | Low | 2-3 hours | Enhancement |
| Type Coverage Report | Low | Low | 3-4 hours | Enhancement |

**Total Estimated Effort for All Items**: 7-11 hours

---

## üéØ Recommended Story Creation Order

1. **Story 1 (High Priority)**: Fix SQL Query Builder Bug in Workflows/Tasks Routers
   - **Why First**: Blocking 13% of test suite, potential runtime issues
   - **Dependencies**: None
   - **Effort**: 2-4 hours

2. **Story 2 (Low Priority)**: Add Type Validation Tests for Centralized tRPC Types
   - **Why Second**: Complements Story 7.1, prevents future regressions
   - **Dependencies**: None
   - **Effort**: 2-3 hours

3. **Story 3 (Low Priority)**: Create Router Type Export Coverage Report Tool
   - **Why Third**: Developer tooling, lowest priority
   - **Dependencies**: None
   - **Effort**: 3-4 hours

---

## üìù Notes

- All items listed here were discovered during Story 7.1 QA review but are **NOT blocking** for Story 7.1 completion
- Story 7.1 received a **PASS** gate decision with 95/100 quality score
- The SQL query builder bug is **pre-existing** and unrelated to the type centralization work
- Enhancement recommendations are **nice-to-have** quality improvements

---

**Document Prepared By**: Quinn (Test Architect)
**Review Date**: 2025-10-26
**Related Story**: 7.1 - Centralize All tRPC Router Output Types
**Gate File**: `docs/qa/gates/7.1-centralize-all-trpc-router-output-types.yml`
